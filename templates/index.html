<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Dashboard</title>
    <link rel="stylesheet" href="res/base.css">
</head>
<body>
<div class="sidebar">
    <div class="editor-mode">
        <input type="checkbox" id="editorMode"> Editor Mode
    </div>
    {% for icon in icons %}
        <a href="#" class="icon" data-url="{{ icon.uri }}">
            <img src="{{ icon.icon_url }}" alt="{{ icon.name }}">
            <h3>{{ icon.name }}</h3>
            <div class="icon-actions" style="display:none;">
                <img src="/res/icons/edit.png" alt="Edit" class="edit-icon" onclick="editService('{{ icon.uri }}')" data-url="{{ icon.uri }}" data-name="{{ icon.name }}" data-icon-url="{{ icon.icon_url }}">
                <img src="/res/icons/delete.png" alt="Delete" class="delete-icon" onclick="deleteService('{{ icon.uri }}')">
            </div>
        </a>
    {% endfor %}
    <div class="icon add-service" id="add-service" style="display:none;">
        <a href="#" id="editorBtn">
            <img src="/res/icons/plus.png" alt="Add Service">
            <h3>Add Service</h3>
        </a>
    </div>
</div>

<iframe class="content-frame" src=""></iframe>

<div class="spinner" id="spinner"></div>
<div class="loading-bar" id="loading-bar"></div>

<div id="editorPopup" class="popup">
    <div class="popup-content">
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Icons')">Icons</button>
            <button class="tablinks" onclick="openTab(event, 'Nginx')">Nginx</button>
        </div>
        <iframe class="editor-frame"></iframe>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const icons = document.querySelectorAll(".icon");
        const iframe = document.querySelector(".content-frame");
        const spinner = document.querySelector(".spinner");
        const loadingBar = document.querySelector(".loading-bar");

        icons.forEach(icon => {
            icon.addEventListener("click", function() {
                const serviceUrl = this.getAttribute("data-url");

                // Show spinner and start loading bar
                spinner.style.display = 'block';
                spinner.style.opacity = '1';  // Ensure it's fully visible
                loadingBar.style.display = 'block';
                loadingBar.style.opacity = '1';  // Ensure it's fully visible

                iframe.onload = function() {
                    // Introduce a delay before hiding the spinner
                    setTimeout(() => {
                        spinner.style.opacity = '0';
                        loadingBar.style.opacity = '0';

                        // After the fade-out effect, hide them from display
                        setTimeout(() => {
                            spinner.style.display = 'none';
                            loadingBar.style.display = 'none';
                        }, 500);  // Match the transition duration from the CSS
                    }, 1000);  // 1-second delay for spinner
                };

                iframe.src = serviceUrl;
                simulateLoadingBar();
            });
        });

        function simulateLoadingBar() {
            let width = 0;
            let interval = setInterval(function() {
                if (width >= 100) {
                    clearInterval(interval);
                    return;
                }
                width += 5;
                loadingBar.style.width = width + '%';
            }, 300);
        }
    });

    const editorModeCheckbox = document.getElementById('editorMode');
    if (editorModeCheckbox) {
        editorModeCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                var ele = document.getElementsByClassName('icon');
                    for (var i = 0; i < ele.length; i++ ) {
                        ele[i].style.pointerEvents = "none";
                    }
                var ele = document.getElementsByClassName('icon-actions');
                    for (var i = 0; i < ele.length; i++ ) {
                        ele[i].style.pointerEvents = "auto";
                    }
                var ele = document.getElementsByClassName('icon-actions');
                    for (var i = 0; i < ele.length; i++ ) {
                        ele[i].style.display = "inline-flex";
                    }
                document.getElementById('add-service').style.pointerEvents = "auto";
                document.getElementById('add-service').style.display = "block";
            } else {
                location.reload()
            }
        });
    }

    document.getElementById('editorBtn').addEventListener('click', function() {
        document.getElementById('editorPopup').style.display = 'block';
        openTab(null, 'Icons'); // default tab content
    });

    function openTab(evt, tabName) {
        const iframe = document.querySelector('.editor-frame');

        if (tabName === 'Icons') {
            iframe.src = "/Editor/Icons.html";  // Set this to your FastAPI route
        } else if (tabName === 'Nginx') {
            iframe.src = "/Editor/Nginx.html";  // Set this to your FastAPI route
        } else if (tabName === 'Delete') {
            iframe.src = "/Editor/Delete.html";  // Set this to your FastAPI route
        } else if (tabName === 'Edit') {
            iframe.src = "/Editor/Edit.html";  // Set this to your FastAPI route
        }



        if (evt) {
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            evt.currentTarget.className += " active";
        }
    }

    window.onclick = function(event) {
        const popup = document.getElementById('editorPopup');
        if (event.target === popup) {
            popup.style.display = 'none';
        }
    };
    window.addEventListener('DOMContentLoaded', (event) => {
        const iframe = document.getElementById('content-frame'); // Assuming you named the iframe "editorFrame"

        iframe.contentWindow.document.getElementById('iconForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const response = await fetch('/API/AddIcon', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.message === "Icon added successfully") {
                alert(result.message);
                setTimeout(() => {
                    location.reload(); // Reload the parent page after 2 seconds
                }, 500);
            } else {
                alert("Error adding icon.");
            }
        });
    });
    async function deleteService(service) {
        try {
            const response = await fetch(`/API/DeleteService?s=${service}`, {
                method: 'POST',
            });
            if (response.ok) {
                location.reload();
            } else {
                console.error('Failed to delete service:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
    }

}
function editService(iconUri) {
    // Find the icon element that matches the given iconUri
    const iconElement = document.querySelector(`.icon[data-url="${iconUri}"]`);
    if (!iconElement) return;

    // Extract the data attributes
    const iconUrl = iconElement.getAttribute('data-icon-url');
    const name = iconElement.getAttribute('data-name');
    const url = iconElement.getAttribute('data-url');

    // Open the Icon Edit popup
    document.getElementById('editorPopup').style.display = 'block';
    openTab(null, 'Icons');

    // Set a listener for the iframe's load event
    const iframe = document.querySelector('.editor-frame');
    iframe.onload = function() {
        // Ensure that we're on the correct iframe source
        if (iframe.src.endsWith("/Editor/Icons.html")) {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            // Set the form fields with the extracted data
            iframeDoc.getElementById('iconURL').value = iconUrl; // assuming the input field has an id of 'iconUrlField'
            iframeDoc.getElementById('serviceName').value = name;       // assuming the input field has an id of 'nameField'
            iframeDoc.getElementById('accessURI').value = url;         // assuming the input field has an id of 'urlField'
        }
    };
}
</script>
</body>
</html>
